name: Publish Results
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches:
      - '**'

jobs:
  publish:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      pull-requests: write
    env:
      RESULT_FILE: "results.json"
      GITHUB_CONTEXT_FILE: "github.json"
      RUN_CONTEXT_FILE: "runner.json"
      FLAMEGRAPH_FILE: "flamegraph.html"

    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/github-script@v7
        with:
          script: |
            // Get artifacts directly from the workflow run that triggered this
            const run_id = context.payload.workflow_run.id;

            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.name,
              run_id: run_id
            });

            const matchArtifact = artifacts.data.artifacts.filter((artifact) => {
              return ["result", "run-metadata", "flamegraph"].includes(artifact.name)
            });

            for (const artifact of matchArtifact) {
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.name,
                artifact_id: artifact.id,
                archive_format: 'zip'
              });

              const fs = require('fs');
              fs.writeFileSync(`${artifact.name}.zip`, Buffer.from(download.data));
            }

      - name: Unzip artifacts
        run: |
          for zip in *.zip
          do
            dirname="${zip%.zip}"
            mkdir -p "$dirname"
            unzip -d "$dirname" "$zip"
          done

      - name: Organize results
        id: organize
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metadata = JSON.parse(fs.readFileSync(`run-metadata/${process.env.GITHUB_CONTEXT_FILE}`, 'utf8'));

            // Extract PR number and run ID
            const prNumber = metadata.event.pull_request?.number || 'main';
            const runId = metadata.run_id;

            // Create directory structure
            const resultDir = `results/pr-${prNumber}/${runId}`;
            fs.mkdirSync(resultDir, { recursive: true });

            // Move files to appropriate directory
            const filesToMove = [
              `result/${process.env.RESULT_FILE}`,
              `run-metadata/${process.env.GITHUB_CONTEXT_FILE}`,
              `run-metadata/${process.env.RUN_CONTEXT_FILE}`
            ];

            filesToMove.forEach(file => {
              if (fs.existsSync(file)) {
                const targetFile = `${resultDir}/${file.split('/').pop()}`;
                fs.copyFileSync(file, targetFile);
              }
            });
            if (fs.existsSync("flamegraph/${process.env.FLAMEGRAPH_FILE}")) {
              fs.copyFileSync("flamegraph/${process.env.FLAMEGRAPH_FILE}", `${resultDir}/${process.env.FLAMEGRAPH_FILE}`);
            }

            // Create index.html for this run
            const resultData = JSON.parse(fs.readFileSync("result/$RESULT_FILE", 'utf8'));
            const indexHtml = `
            <!DOCTYPE html>
            <html>
              <!-- ... header remains the same ... -->
              <body class="bg-gray-100 p-8">
                <div class="max-w-4xl mx-auto">
                  <h1 class="text-3xl font-bold mb-8">Benchmark Results</h1>
                  ${fs.existsSync(`${resultDir}/${process.env.FLAMEGRAPH_FILE}`) ? `
                    <div class="bg-white rounded-lg shadow p-6 mb-8">
                      <h2 class="text-xl font-semibold mb-4">Flamegraph</h2>
                      <a href="${process.env.FLAMEGRAPH_FILE}" class="text-blue-600 hover:underline">View Flamegraph</a>
                    </div>
                  ` : ''}
                  <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">PR #${prNumber} - Run ${runId}</h2>
                    <div class="overflow-x-auto">
                      <table class="min-w-full table-auto">
                        <thead>
                          <tr class="bg-gray-50">
                            <th class="px-4 py-2">Command</th>
                            <th class="px-4 py-2">Mean (s)</th>
                            <th class="px-4 py-2">Std Dev</th>
                            <th class="px-4 py-2">User (s)</th>
                            <th class="px-4 py-2">System (s)</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${resultData.results.map(result => `
                            <tr class="border-t">
                              <td class="px-4 py-2 font-mono text-sm">${result.command}</td>
                              <td class="px-4 py-2 text-right">${result.mean.toFixed(3)}</td>
                              <td class="px-4 py-2 text-right">${result.stddev?.toFixed(3) || 'N/A'}</td>
                              <td class="px-4 py-2 text-right">${result.user.toFixed(3)}</td>
                              <td class="px-4 py-2 text-right">${result.system.toFixed(3)}</td>
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </body>
            </html>`;

            fs.writeFileSync(`${resultDir}/index.html`, indexHtml);

            // Update main index.html
            let mainIndexHtml = `
            <!DOCTYPE html>
            <html>
              <head>
                <title>Bitcoin Benchmark Results</title>
                <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
              </head>
              <body class="bg-gray-100 p-8">
                <div class="max-w-4xl mx-auto">
                  <h1 class="text-3xl font-bold mb-8">Bitcoin Benchmark Results</h1>
                  <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Available Results</h2>
                    <ul class="space-y-2">
            `;

            // List all PR directories
            const prs = fs.readdirSync('results')
              .filter(dir => dir.startsWith('pr-'))
              .map(dir => ({
                pr: dir.replace('pr-', ''),
                runs: fs.readdirSync(`results/${dir}`)
              }));

            prs.forEach(({pr, runs}) => {
              mainIndexHtml += `
                <li class="font-semibold">PR #${pr}
                  <ul class="ml-8 space-y-1">
              `;

              runs.forEach(run => {
                mainIndexHtml += `
                    <li><a href="pr-${pr}/${run}/index.html" class="text-blue-600 hover:underline">Run ${run}</a></li>
                `;
              });

              mainIndexHtml += `
                  </ul>
                </li>
              `;
            });

            mainIndexHtml += `
                    </ul>
                  </div>
                </div>
              </body>
            </html>
            `;

            fs.writeFileSync('results/index.html', mainIndexHtml);

            // Return the URL for the PR comment
            const resultUrl = `https://${context.repo.owner}.github.io/${context.repo.name}/results/pr-${prNumber}/${runId}/index.html`;
            core.setOutput('result-url', resultUrl);
            return resultUrl;

      - name: Commit and push results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add results/
          git commit -m "Add benchmark results for run ${{ github.event.workflow_run.id }}"
          git push

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metadata = JSON.parse(fs.readFileSync(`run-metadata/${process.env.GITHUB_CONTEXT_FILE}`, 'utf8'));
            const prNumber = metadata.event.pull_request?.number;

            if (prNumber) {
              const resultUrl = '${{ steps.organize.outputs.result-url }}';
              let comment = `ðŸ“Š Benchmark results for this run are available at: ${resultUrl}`;

              const resultDir = `results/pr-${prNumber}/${metadata.run_id}`;
              if (fs.existsSync(`${resultDir}/${process.env.FLAMEGRAPH_FILE}`)) {
                const flamegraphUrl = resultUrl.replace('index.html', `${process.env.FLAMEGRAPH_FILE}`);
                comment += `\nðŸ”¥ Flamegraph available at: ${flamegraphUrl}`;
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.name,
                issue_number: prNumber,
                body: comment
              });
            }
