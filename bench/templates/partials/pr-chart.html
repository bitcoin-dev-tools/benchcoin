<div id="pr-comparison-chart" style="width:100%; height:800px;"></div>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
  const nightlyData = {{ nightly_chart_data | tojson }};
  const prData = {{ pr_chart_data | tojson }};

  const PALETTE = [
    '#636EFA', '#EF553B', '#00CC96', '#AB63FA', '#FFA15A',
    '#19D3F3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52'
  ];

  function getSeriesColor(colorIndex) {
    return PALETTE[colorIndex % PALETTE.length];
  }

  function getErrorColor(hexColor) {
    const r = parseInt(hexColor.slice(1, 3), 16);
    const g = parseInt(hexColor.slice(3, 5), 16);
    const b = parseInt(hexColor.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, 0.3)`;
  }

  const toMinutes = (seconds) => seconds / 60;

  function buildTraces() {
    const traces = [];

    const nightlySeriesMap = new Map();
    nightlyData.forEach(d => {
      const key = d.series_key || d.config;
      if (!nightlySeriesMap.has(key)) {
        nightlySeriesMap.set(key, {
          label: d.series_label || (d.config + ' dbcache'),
          colorIndex: d.color_index || 0,
          points: []
        });
      }
      nightlySeriesMap.get(key).points.push(d);
    });

    const sortedSeries = Array.from(nightlySeriesMap.entries())
      .sort((a, b) => a[1].label.localeCompare(b[1].label));

    sortedSeries.forEach(([seriesKey, series]) => {
      const points = series.points.sort((a, b) => a.date.localeCompare(b.date));
      const color = getSeriesColor(series.colorIndex);

      traces.push({
        name: series.label + ' (nightly)',
        x: points.map(d => d.date),
        y: points.map(d => toMinutes(d.mean)),
        text: points.map(d => d.commit.slice(0, 8)),
        customdata: points.map(d => [d.commit, toMinutes(d.stddev || 0)]),
        hovertemplate: '<b>%{text}</b><br>%{y:.1f} min<br>\u00b1%{customdata[1]:.1f} min<extra>' + series.label + ' nightly</extra>',
        mode: 'lines+markers',
        line: { color: color, width: 2 },
        marker: { size: 6 },
        error_y: {
          type: 'data',
          array: points.map(d => toMinutes(d.stddev || 0)),
          visible: true,
          color: getErrorColor(color),
          thickness: 1.5
        }
      });
    });

    prData.forEach(pr => {
      const key = pr.series_key || pr.config;
      const label = pr.series_label || (pr.config + ' dbcache');
      const color = getSeriesColor(pr.color_index || 0);

      traces.push({
        name: label + ' (PR)',
        x: [pr.date],
        y: [toMinutes(pr.mean)],
        text: [pr.commit.slice(0, 8)],
        customdata: [[pr.commit, toMinutes(pr.stddev || 0)]],
        hovertemplate: '<b>PR %{text}</b><br>%{y:.1f} min<br>\u00b1%{customdata[1]:.1f} min<extra>' + label + ' PR</extra>',
        mode: 'markers',
        marker: {
          symbol: 'star',
          size: 16,
          color: color,
          line: { color: '#ffffff', width: 2 }
        },
        showlegend: false
      });
    });

    return traces;
  }

  const layout = {
    title: {
      text: 'PR vs Nightly Sync Performance',
      font: { size: 16 }
    },
    xaxis: {
      title: { text: 'Date' },
      tickangle: -45
    },
    yaxis: {
      title: { text: 'Time (minutes)' },
      rangemode: 'tozero'
    },
    legend: {
      orientation: 'h',
      yanchor: 'top',
      y: -0.15,
      xanchor: 'center',
      x: 0.5,
      font: { size: 11 },
      itemclick: 'toggle',
      itemdoubleclick: 'toggleothers'
    },
    hovermode: 'closest',
    margin: { t: 60, b: 150 }
  };

  const config = {
    responsive: true,
    displayModeBar: 'hover',
    modeBarButtonsToRemove: ['lasso2d', 'select2d', 'autoScale2d'],
    displaylogo: false
  };

  Plotly.newPlot('pr-comparison-chart', buildTraces(), layout, config);
</script>
