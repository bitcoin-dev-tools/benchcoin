{% extends 'base.html' %}

{% block title %}Bitcoin Core Nightly IBD Benchmark{% endblock %}

{% block head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  :root {
    --bg-primary: #f3f4f6;
    --bg-card: #ffffff;
    --text-primary: #111827;
    --text-secondary: #4b5563;
    --text-muted: #6b7280;
    --link-color: #2563eb;
    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
  }
  .dark {
    --bg-primary: #111827;
    --bg-card: #1f2937;
    --text-primary: #f9fafb;
    --text-secondary: #d1d5db;
    --text-muted: #9ca3af;
    --link-color: #60a5fa;
    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3);
  }
  body {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    transition: background-color 0.2s, color 0.2s;
  }
  .card {
    background-color: var(--bg-card);
    box-shadow: var(--shadow);
    transition: background-color 0.2s;
  }
  .text-secondary { color: var(--text-secondary); }
  .text-muted { color: var(--text-muted); }
  .link { color: var(--link-color); }
  .theme-toggle {
    position: fixed;
    top: 1rem;
    right: 1rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    background-color: var(--bg-card);
    border: 1px solid var(--text-muted);
    cursor: pointer;
    font-size: 1.25rem;
    transition: background-color 0.2s;
  }
  .theme-toggle:hover {
    opacity: 0.8;
  }
</style>
{% endblock %}

{% block body_class %}p-4 md:p-8{% endblock %}

{% block content %}
{% include 'partials/theme-toggle.html' %}
<div class="w-full">
  <h1 class="text-3xl font-bold mb-2">Bitcoin Core Nightly IBD Benchmark</h1>
  <p class="text-secondary mb-4">
    IBD from a single networked peer
  </p>
  <div class="card rounded-lg p-4">
    <div id="nightly-chart" style="width:100%; height:calc(100vh - 200px); min-height:400px;"></div>
  </div>
  <p class="text-sm text-muted mt-4 text-center">
    <a href="results/" class="link hover:underline">View PR benchmark results</a>
  </p>
</div>
{% endblock %}

{% block scripts %}
<script>
  const data = {{ chart_data | tojson }};

  const PALETTE = [
    '#636EFA', '#EF553B', '#00CC96', '#AB63FA', '#FFA15A',
    '#19D3F3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52'
  ];

  function getSeriesColor(colorIndex) {
    return PALETTE[colorIndex % PALETTE.length];
  }

  function getErrorColor(hexColor) {
    const r = parseInt(hexColor.slice(1, 3), 16);
    const g = parseInt(hexColor.slice(3, 5), 16);
    const b = parseInt(hexColor.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, 0.3)`;
  }

  const toMinutes = (seconds) => seconds / 60;

  function buildTraces() {
    const seriesMap = new Map();

    data.forEach(d => {
      const key = d.series_key || d.config;
      if (!seriesMap.has(key)) {
        seriesMap.set(key, {
          label: d.series_label || (d.config + ' dbcache'),
          colorIndex: d.color_index || 0,
          points: []
        });
      }
      seriesMap.get(key).points.push(d);
    });

    const traces = [];
    const sortedSeries = Array.from(seriesMap.entries())
      .sort((a, b) => a[1].label.localeCompare(b[1].label));

    sortedSeries.forEach(([seriesKey, series]) => {
      const points = series.points.sort((a, b) => a.date.localeCompare(b.date));
      const color = getSeriesColor(series.colorIndex);

      traces.push({
        name: series.label,
        x: points.map(d => d.date),
        y: points.map(d => toMinutes(d.mean)),
        text: points.map(d => d.commit.slice(0, 8)),
        customdata: points.map(d => [d.commit, toMinutes(d.stddev || 0)]),
        hovertemplate: '<b>%{text}</b><br>%{y:.1f} min<br>\u00b1%{customdata[1]:.1f} min<extra>' + series.label + '</extra>',
        mode: 'lines+markers',
        line: { color: color, width: 2 },
        marker: { size: 8 },
        error_y: {
          type: 'data',
          array: points.map(d => toMinutes(d.stddev || 0)),
          visible: true,
          color: getErrorColor(color),
          thickness: 1.5
        }
      });
    });

    return traces;
  }

  function getLayout(theme) {
    const isDark = theme === 'dark';
    return {
      title: {
        text: 'Sync from block 840,000 to 900,000',
        font: { size: 18, color: isDark ? '#f9fafb' : '#111827' }
      },
      xaxis: {
        title: { text: 'Date', font: { color: isDark ? '#d1d5db' : '#4b5563' } },
        tickangle: -45,
        tickfont: { color: isDark ? '#9ca3af' : '#6b7280' },
        gridcolor: isDark ? '#374151' : '#e5e7eb',
        linecolor: isDark ? '#4b5563' : '#d1d5db'
      },
      yaxis: {
        title: { text: 'Time (minutes)', font: { color: isDark ? '#d1d5db' : '#4b5563' } },
        rangemode: 'tozero',
        tickfont: { color: isDark ? '#9ca3af' : '#6b7280' },
        gridcolor: isDark ? '#374151' : '#e5e7eb',
        linecolor: isDark ? '#4b5563' : '#d1d5db'
      },
      legend: {
        orientation: 'h',
        yanchor: 'top',
        y: -0.15,
        xanchor: 'center',
        x: 0.5,
        font: { color: isDark ? '#d1d5db' : '#4b5563', size: 11 },
        bgcolor: isDark ? 'rgba(31, 41, 55, 0.8)' : 'rgba(255, 255, 255, 0.8)',
        bordercolor: isDark ? '#4b5563' : '#d1d5db',
        borderwidth: 1,
        itemclick: 'toggle',
        itemdoubleclick: 'toggleothers'
      },
      hovermode: 'closest',
      hoverlabel: {
        bgcolor: isDark ? '#1f2937' : '#ffffff',
        bordercolor: isDark ? '#4b5563' : '#d1d5db',
        font: { color: isDark ? '#f9fafb' : '#111827', size: 13 }
      },
      margin: { t: 80, b: 150 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)'
    };
  }

  const config = {
    responsive: true,
    displayModeBar: 'hover',
    modeBarButtonsToRemove: ['lasso2d', 'select2d', 'autoScale2d'],
    displaylogo: false
  };

  function updateChart(theme) {
    Plotly.react('nightly-chart', buildTraces(), getLayout(theme), config);
  }

  setTheme(getPreferredTheme());

  document.getElementById('nightly-chart').on('plotly_click', function(data) {
    const commit = data.points[0].customdata[0];
    window.open('https://github.com/bitcoin/bitcoin/commit/' + commit, '_blank');
  });
</script>
{% endblock %}
