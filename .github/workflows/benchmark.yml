name: Benchmark
on:
  pull_request:
    branches:
      - master

jobs:
  build-binaries:
    runs-on: [self-hosted, linux, x64]
    env:
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fetch base commit
        run: |
          echo "HEAD_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"
          git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}

      - name: Build both binaries
        run: |
          nix develop --command python3 bench.py build \
            --binaries-dir ${{ runner.temp }}/binaries \
            $BASE_SHA $HEAD_SHA

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: bitcoind-binaries
          path: ${{ runner.temp }}/binaries/

  uninstrumented:
    needs: build-binaries
    strategy:
      matrix:
        include:
          - name: mainnet-default-uninstrumented
            timeout: 600
            dbcache: 450
          - name: mainnet-large-uninstrumented
            timeout: 600
            dbcache: 32000
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: ${{ matrix.timeout }}
    env:
      ORIGINAL_DATADIR: /data/pruned-840k
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: bitcoind-binaries
          path: ${{ runner.temp }}/binaries

      - name: Set binary permissions
        run: |
          chmod +x ${{ runner.temp }}/binaries/base/bitcoind
          chmod +x ${{ runner.temp }}/binaries/head/bitcoind

      - name: Fetch base commit
        run: |
          echo "HEAD_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"
          git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}

      - name: Run benchmark
        run: |
          nix develop --command python3 bench.py --profile ci run \
            --binaries-dir ${{ runner.temp }}/binaries \
            --datadir $ORIGINAL_DATADIR \
            --tmp-datadir ${{ runner.temp }}/datadir \
            --output-dir ${{ runner.temp }}/output \
            --dbcache ${{ matrix.dbcache }} \
            $BASE_SHA $HEAD_SHA

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.name }}
          path: ${{ runner.temp }}/output/results.json

      - name: Write context metadata
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
          RUNNER_CONTEXT: ${{ toJSON(runner) }}
        run: |
          mkdir -p ${{ runner.temp }}/contexts
          echo "$GITHUB_CONTEXT" | jq "del(.token)" > ${{ runner.temp }}/contexts/github.json
          echo "$RUNNER_CONTEXT" > ${{ runner.temp }}/contexts/runner.json

      - name: Upload context metadata
        uses: actions/upload-artifact@v4
        with:
          name: run-metadata-${{ matrix.name }}
          path: ${{ runner.temp }}/contexts/

  instrumented:
    needs: build-binaries
    strategy:
      matrix:
        include:
          - name: mainnet-default-instrumented
            timeout: 600
            dbcache: 450
          - name: mainnet-large-instrumented
            timeout: 600
            dbcache: 32000
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: ${{ matrix.timeout }}
    env:
      ORIGINAL_DATADIR: /data/pruned-840k
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: bitcoind-binaries
          path: ${{ runner.temp }}/binaries

      - name: Set binary permissions
        run: |
          chmod +x ${{ runner.temp }}/binaries/base/bitcoind
          chmod +x ${{ runner.temp }}/binaries/head/bitcoind

      - name: Fetch base commit
        run: |
          echo "HEAD_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"
          git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}

      - name: Run instrumented benchmark
        run: |
          nix develop --command python3 bench.py --profile ci run \
            --instrumented \
            --binaries-dir ${{ runner.temp }}/binaries \
            --datadir $ORIGINAL_DATADIR \
            --tmp-datadir ${{ runner.temp }}/datadir \
            --output-dir ${{ runner.temp }}/output \
            --dbcache ${{ matrix.dbcache }} \
            $BASE_SHA $HEAD_SHA

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.name }}
          path: ${{ runner.temp }}/output/results.json

      - name: Upload plots
        uses: actions/upload-artifact@v4
        with:
          name: pngs-${{ matrix.name }}
          path: ${{ runner.temp }}/output/plots/*.png
          if-no-files-found: ignore

      - name: Upload flamegraphs
        uses: actions/upload-artifact@v4
        with:
          name: flamegraph-${{ matrix.name }}
          path: ${{ runner.temp }}/output/*-flamegraph.svg
          if-no-files-found: ignore

      - name: Write context metadata
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
          RUNNER_CONTEXT: ${{ toJSON(runner) }}
        run: |
          mkdir -p ${{ runner.temp }}/contexts
          echo "$GITHUB_CONTEXT" | jq "del(.token)" > ${{ runner.temp }}/contexts/github.json
          echo "$RUNNER_CONTEXT" > ${{ runner.temp }}/contexts/runner.json

      - name: Upload context metadata
        uses: actions/upload-artifact@v4
        with:
          name: run-metadata-${{ matrix.name }}
          path: ${{ runner.temp }}/contexts/
