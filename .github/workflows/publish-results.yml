name: Publish Results
on:
  workflow_run:
    workflows: ["Benchmark"]
    types: [completed]
jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      actions: read
      contents: write
      checks: read
    env:
      # Matrix entries from configs/pr.toml: dbcache=[450,32000] x instrumentation=[uninstrumented,instrumented]
      NETWORKS: "450-uninstrumented,450-instrumented,32000-uninstrumented,32000-instrumented"
      # Machine ID for nightly history file (PR benchmarks run on x64 runners)
      MACHINE_ID: "amd64"
    outputs:
      comparison: ${{ steps.generate.outputs.comparison }}
      pr-number: ${{ steps.metadata.outputs.pr-number }}
      result-url: ${{ steps.generate.outputs.result-url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Checkout benchcoin tools
        uses: actions/checkout@v4
        with:
          ref: master
          path: benchcoin-tools

      - name: Download artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download ${{ github.event.workflow_run.id }} --repo ${{ github.repository }}

      - name: Extract artifacts
        run: |
          for network in ${NETWORKS//,/ }; do
            # Create network-specific directories with results
            if [ -d "result-${network}" ]; then
              mkdir -p "${network}-results"
              mv "result-${network}/results.json" "${network}-results/"
            fi

            # Copy flamegraphs into network results directory
            if [ -d "flamegraph-${network}" ]; then
              cp -r "flamegraph-${network}"/* "${network}-results/" 2>/dev/null || true
            fi

            # Copy plots into network results directory
            if [ -d "pngs-${network}" ]; then
              mkdir -p "${network}-results/plots"
              cp -r "pngs-${network}"/* "${network}-results/plots/" 2>/dev/null || true
            fi

            # Keep metadata separate for extraction
            if [ -d "run-metadata-${network}" ]; then
              mkdir -p "${network}-metadata"
              mv "run-metadata-${network}"/* "${network}-metadata/"
            fi
          done

      - name: Extract metadata
        id: metadata
        run: |
          # Find PR number, run ID, and commit from any available metadata
          for network in ${NETWORKS//,/ }; do
            if [ -f "${network}-metadata/github.json" ]; then
              PR_NUMBER=$(jq -r '.event.pull_request.number // "main"' "${network}-metadata/github.json")
              RUN_ID=$(jq -r '.run_id' "${network}-metadata/github.json")
              HEAD_SHA=$(jq -r '.event.pull_request.head.sha // .sha' "${network}-metadata/github.json")
              echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
              echo "run-id=${RUN_ID}" >> $GITHUB_OUTPUT
              echo "head-sha=${HEAD_SHA}" >> $GITHUB_OUTPUT
              echo "Found metadata: PR=${PR_NUMBER}, Run=${RUN_ID}, Commit=${HEAD_SHA}"
              break
            fi
          done

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Generate report
        id: generate
        env:
          PR_NUMBER: ${{ steps.metadata.outputs.pr-number }}
          RUN_ID: ${{ steps.metadata.outputs.run-id }}
          HEAD_SHA: ${{ steps.metadata.outputs.head-sha }}
        run: |
          # Build network arguments
          NETWORK_ARGS=""
          for network in ${NETWORKS//,/ }; do
            if [ -d "./${network}-results" ]; then
              NETWORK_ARGS="${NETWORK_ARGS} --network ${network}:./${network}-results"
            fi
          done

          # Generate report with nightly comparison (use per-machine history file)
          nix develop ./benchcoin-tools --command python3 benchcoin-tools/bench.py report \
            ${NETWORK_ARGS} \
            --pr-number "${PR_NUMBER}" \
            --run-id "${RUN_ID}" \
            --commit "${HEAD_SHA}" \
            --nightly-history "./nightly-history-${MACHINE_ID}.json" \
            --update-index \
            "./results/pr-${PR_NUMBER}/${RUN_ID}"

          # Build comparison summary for PR comment
          if [ -f "./nightly-history-${MACHINE_ID}.json" ]; then
            COMPARISON=$(jq -r '
              if .nightly_comparison then
                .nightly_comparison | to_entries | map(
                  "\(.key) MB: \(.value.pr_mean / 60 | floor) min" +
                  if .value.nightly_mean then
                    " (nightly: \(.value.nightly_mean / 60 | floor) min, \(.value.nightly_date)) â†’ " +
                    if .value.speedup_percent > 0 then "+\(.value.speedup_percent)% faster"
                    elif .value.speedup_percent < 0 then "\(.value.speedup_percent)% slower"
                    else "same"
                    end
                  else " (no nightly baseline)"
                  end
                ) | join("\n- ")
              else "No comparison data available"
              end
            ' "./results/pr-${PR_NUMBER}/${RUN_ID}/results.json")
          else
            COMPARISON="No nightly history available for comparison"
          fi
          echo "comparison<<EOF" >> $GITHUB_OUTPUT
          echo "${COMPARISON}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          RESULT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/results/pr-${PR_NUMBER}/${RUN_ID}/index.html"
          echo "result-url=${RESULT_URL}" >> $GITHUB_OUTPUT

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: results

      - name: Commit and push to gh-pages
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Note: Only add results/ directory, not root index.html
          # The root index.html is managed by nightly-benchmark.yml
          git add results/
          git commit -m "Update benchmark results from run ${{ github.event.workflow_run.id }}"
          git push origin gh-pages

  comment-pr:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read
    steps:
      - name: Comment on PR
        if: ${{ needs.build.outputs.pr-number != 'main' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ needs.build.outputs.pr-number }} \
            --repo ${{ github.repository }} \
            --body "## Benchmark Results

          **Comparison to nightly master:**
          - ${{ needs.build.outputs.comparison }}

          [View detailed results](${{ needs.build.outputs.result-url }})
          [View nightly trend chart](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)"
